---
interface FormData {
  name: string;
  company: string;
  phone: string;
  email: string;
  vcpu: string;
  ram: string;
  storage: string;
  useCase: string;
  os: string;
  controlPanel: string;
  managedServices: string;
  backup: string;
}

interface FormErrors {
  [key: string]: string;
}
---


<section class="lg:my-[150px] demande-devis my-[80px] bg-gray-200 py-16">
  <div class="container mx-auto px-20">
    <div class="max-w-6xl mx-auto">
      <!-- Header -->
      <div class="text-center mb-12">
        <h2 class="text-title text-3xl md:text-4xl lg:text-5xl poppins-semibold  mb-6">
          Demande de devis
          <br />
          Cloud VPS Maroc
        </h2>
        <p class="paragraph text-lg max-w-3xl mx-auto">
          L'équipe Hostino® est à votre écoute : remplissez le formulaire
          ci-dessous et l'un de nos experts vous contactera
          <strong>dans les 24 heures</strong> pour répondre à toutes vos
          questions.
        </p>
      </div>

      <!-- Success Message -->
      <div id="success-message" class="hidden bg-green-100 border border-green-400 text-green-700 px-6 py-4 rounded-lg mb-8 text-center">
        <p class="poppins-semibold ">
          ✓ Votre demande a été envoyée avec succès !
        </p>
        <p class="text-sm mt-1">
          Nous vous contactons dans les 24 heures.
        </p>
      </div>

      <!-- Form -->
      <form id="vps-quote-form" class="bg-white rounded-[10px] p-8 md:p-12">
        <!-- Name and Company -->
        <div class="grid md:grid-cols-2 gap-6 mb-6">
          <div>
            <label
              for="name"
              class="block text-title text-[17] font-medium mb-2"
            >
              Nom et prénom
            </label>
            <input
              type="text"
              id="name"
              name="name"
              class="vps-form-input w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition"
              placeholder=""
            />
          </div>
          <div>
            <label
              for="company"
              class="block text-title text-[17] font-medium mb-2"
            >
              Entreprise <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="company"
              name="company"
              required
              class="vps-form-input w-full px-4 py-3 bg-gray-50 border rounded-lg focus:outline-none transition"
              placeholder=""
            />
            <p class="error-message text-red-500 text-xs mt-1 hidden" data-field="company"></p>
          </div>
        </div>

        <!-- Phone and Email -->
        <div class="grid md:grid-cols-2 gap-6 mb-8">
          <div>
            <label
              for="phone"
              class="block text-title text-[17] font-medium mb-2"
            >
              Téléphone <span class="text-red-500">*</span>
            </label>
            <input
              type="tel"
              id="phone"
              name="phone"
              required
              class="vps-form-input w-full px-4 py-3 bg-gray-50 border rounded-lg focus:outline-none transition"
              placeholder="+212 6XX XXX XXX"
            />
            <p class="error-message text-red-500 text-xs mt-1 hidden" data-field="phone"></p>
          </div>
          <div>
            <label
              for="email"
              class="block text-title text-[17] font-medium mb-2"
            >
              Email <span class="text-red-500">*</span>
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="vps-form-input w-full px-4 py-3 bg-gray-50 border rounded-lg focus:outline-none transition"
              placeholder="exemple@entreprise.ma"
            />
            <p class="error-message text-red-500 text-xs mt-1 hidden" data-field="email"></p>
          </div>
        </div>

        <!-- Vos besoins -->
        <div class="mb-8">
          <h3 class="text-title text-xl poppins-semibold  mb-6">
            Vos besoins :
          </h3>

          <div class="grid md:grid-cols-3 gap-6 mb-6">
            <div>
              <label
                for="vcpu"
                class="block text-title text-[17] font-medium mb-2"
              >
                vCPU <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="vcpu"
                name="vcpu"
                required
                class="vps-form-input w-full px-4 py-3 bg-gray-50 border rounded-lg focus:outline-none transition"
                placeholder="4"
              />
              <p class="error-message text-red-500 text-xs mt-1 hidden" data-field="vcpu"></p>
            </div>
            <div>
              <label
                for="ram"
                class="block text-title text-[17] font-medium mb-2"
              >
                RAM <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="ram"
                name="ram"
                required
                class="vps-form-input w-full px-4 py-3 bg-gray-50 border rounded-lg focus:outline-none transition"
                placeholder="8 GB"
              />
              <p class="error-message text-red-500 text-xs mt-1 hidden" data-field="ram"></p>
            </div>
            <div>
              <label
                for="storage"
                class="block text-title text-[17] font-medium mb-2"
              >
                Stockage <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="storage"
                name="storage"
                required
                class="vps-form-input w-full px-4 py-3 bg-gray-50 border rounded-lg focus:outline-none transition"
                placeholder="100 GB"
              />
              <p class="error-message text-red-500 text-xs mt-1 hidden" data-field="storage"></p>
            </div>
          </div>

          <div>
            <label
              for="useCase"
              class="block text-title text-[17] font-medium mb-2"
            >
              Cas d'utilisation :
            </label>
            <input
              type="text"
              id="useCase"
              name="useCase"
              class="vps-form-input w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition"
              placeholder="Ex: Hébergement web, base de données..."
            />
          </div>
        </div>

        <!-- Informations supplémentaires -->
        <div class="mb-8">
          <h3 class="text-title text-xl poppins-semibold  mb-6">
            Informations supplémentaires :
          </h3>

          <div class="mb-6">
            <label
              for="os"
              class="block text-title text-[17] font-medium mb-2"
            >
              Système d'exploitation :
              <span class="text-red-500">*</span>
            </label>
            <select
              id="os"
              name="os"
              required
              class="vps-form-input w-full px-4 py-3 bg-gray-50 border rounded-lg focus:outline-none transition appearance-none cursor-pointer"
            >
              <option value="">Veuillez choisir</option>
              <option value="linux">
                Linux (Ubuntu, Debian, CentOS, Almalinux...)
              </option>
              <option value="windows">
                Windows Server (2016,2019,2022)
              </option>
            </select>
            <p class="error-message text-red-500 text-xs mt-1 hidden" data-field="os"></p>
          </div>

          <div class="mb-6">
            <label
              for="controlPanel"
              class="block text-title text-[17] font-medium mb-2"
            >
              Panneau de contrôle : <span class="text-red-500">*</span>
            </label>
            <select
              id="controlPanel"
              name="controlPanel"
              required
              class="vps-form-input w-full px-4 py-3 bg-gray-50 border rounded-lg focus:outline-none transition appearance-none cursor-pointer"
            >
              <option value="">Veuillez choisir</option>
              <option value="none">Aucun</option>
              <option value="cpanel">cPanel</option>
              <option value="plesk">Plesk</option>
              <option value="other">Autre</option>
            </select>
            <p class="error-message text-red-500 text-xs mt-1 hidden" data-field="controlPanel"></p>
          </div>

          <div class="mb-6">
            <p class="block text-title text-[17] poppins-regular mb-3">
              Avez-vous besoin d'infogérance ?
            </p>
            <div class="flex gap-8">
              <label class="label-radio">
                <input
                  type="radio"
                  name="managedServices"
                  value="yes"
                  class="vps-form-input"
                />
                <span class="truncate">Oui</span>
              </label>
              <label class="label-radio">
                <input
                  type="radio"
                  name="managedServices"
                  value="non"
                  class="vps-form-input"
                />
                <span class="truncate">Non</span>
              </label>
            </div>
          </div>

          <div class="mb-8">
            <p class="block text-title text-[17] poppins-regular mb-3">
              Avez-vous besoin d'une sauvegarde distante ?
            </p>
            <div class="flex gap-8">
              <label class="label-radio">
                <input
                  type="radio"
                  name="backup"
                  value="yes"
                  class="vps-form-input"
                />
                <span class="truncate">Oui</span>
              </label>
              <label class="label-radio">
                <input
                  type="radio"
                  name="backup"
                  value="non"
                  class="vps-form-input"
                />
                <span class="truncate">Non</span>
              </label>
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="text-center">
          <button
            type="submit"
            id="submit-btn"
            class="bg-primary hover:bg-primary/90 text-white poppins-semibold  px-[150px] py-2 rounded-full transition duration-300 transform shadow-lg"
          >
            Envoyer
          </button>
        </div>

        <!-- Footer Note -->
        <p class=" text-[14px] text-center mt-6 text-gray-600">
          En cliquant sur "Envoyer", vous autorisez Hostino™ à traiter les
          données que vous avez fournis, conformément à sa
          <a
            href="/politique-de-confidentialite/"
            class="text-green-600 hover:underline"
          >
            politique de confidentialité
          </a>
          .
        </p>
      </form>
    </div>
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("vps-quote-form") as HTMLFormElement;
    const submitBtn = document.getElementById("submit-btn") as HTMLButtonElement;
    const successMessage = document.getElementById("success-message") as HTMLElement;
    const touched: { [key: string]: boolean } = {};
    const errors: { [key: string]: string } = {};

    const validateField = (name: string, value: string): string => {
      switch (name) {
        case "company":
          if (!value.trim()) return "Le nom de l'entreprise est requis";
          if (value.trim().length < 2)
            return "Le nom de l'entreprise doit contenir au moins 2 caractères";
          return "";

        case "phone":
          if (!value.trim()) return "Le numéro de téléphone est requis";
          const phoneRegex = /^(\+212|0)[5-7][0-9]{8}$/;
          if (!phoneRegex.test(value.replace(/\s/g, ""))) {
            return "Veuillez entrer un numéro de téléphone marocain valide";
          }
          return "";

        case "email":
          if (!value.trim()) return "L'email est requis";
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(value))
            return "Veuillez entrer une adresse email valide";
          return "";

        case "vcpu":
          if (!value.trim()) return "Le nombre de vCPU est requis";
          const vcpuNum = parseInt(value);
          if (isNaN(vcpuNum) || vcpuNum < 1 || vcpuNum > 128) {
            return "Veuillez entrer un nombre de vCPU valide (1-128)";
          }
          return "";

        case "ram":
          if (!value.trim()) return "La RAM est requise";
          if (!/^\d+\s?(GB|Go|MB|Mo)$/i.test(value.trim())) {
            return "Format invalide. Exemple: 4 GB, 8 Go";
          }
          return "";

        case "storage":
          if (!value.trim()) return "Le stockage est requis";
          if (!/^\d+\s?(GB|Go|TB|To|MB|Mo)$/i.test(value.trim())) {
            return "Format invalide. Exemple: 100 GB, 1 TB";
          }
          return "";

        case "os":
          if (!value) return "Veuillez sélectionner un système d'exploitation";
          return "";

        case "controlPanel":
          if (!value) return "Veuillez sélectionner un panneau de contrôle";
          return "";

        default:
          return "";
      }
    };

    const getInputClasses = (fieldName: string, hasError: boolean): string => {
      const baseClasses =
        "w-full px-4 py-3 bg-gray-50 border rounded-lg focus:outline-none transition";
      
      if (hasError) {
        return `${baseClasses} border-red-500 focus:ring-2 focus:ring-red-500`;
      }

      return `${baseClasses} border-gray-200 focus:ring-2 focus:ring-green-500 focus:border-transparent`;
    };

    const updateInputClasses = (input: HTMLElement, hasError: boolean) => {
      const classes = getInputClasses("", hasError).split(" ");
      input.className = classes.join(" ");
    };

    const showError = (fieldName: string, message: string) => {
      const errorElement = document.querySelector(
        `.error-message[data-field="${fieldName}"]`
      ) as HTMLElement;
      const input = form.querySelector(
        `[name="${fieldName}"]`
      ) as HTMLElement;

      if (errorElement) {
        errorElement.textContent = message;
        errorElement.classList.remove("hidden");
      }
      if (input) {
        updateInputClasses(input, true);
      }
    };

    const hideError = (fieldName: string) => {
      const errorElement = document.querySelector(
        `.error-message[data-field="${fieldName}"]`
      ) as HTMLElement;
      const input = form.querySelector(
        `[name="${fieldName}"]`
      ) as HTMLElement;

      if (errorElement) {
        errorElement.classList.add("hidden");
      }
      if (input) {
        updateInputClasses(input, false);
      }
    };

    const handleInputChange = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLSelectElement;
      const { name, value } = target;

      if (touched[name]) {
        const error = validateField(name, value);
        if (error) {
          errors[name] = error;
          showError(name, error);
        } else {
          delete errors[name];
          hideError(name);
        }
      }
    };

    const handleBlur = (e: Event) => {
      const target = e.target as HTMLInputElement | HTMLSelectElement;
      const { name, value } = target;

      touched[name] = true;
      const error = validateField(name, value);
      if (error) {
        errors[name] = error;
        showError(name, error);
      } else {
        delete errors[name];
        hideError(name);
      }
    };

    const validateForm = (): boolean => {
      const newErrors: { [key: string]: string } = {};
      const formData = new FormData(form);

      const requiredFields = [
        "company",
        "phone",
        "email",
        "vcpu",
        "ram",
        "storage",
        "os",
        "controlPanel",
      ];

      requiredFields.forEach((field) => {
        const value = formData.get(field) as string;
        const error = validateField(field, value || "");
        if (error) {
          newErrors[field] = error;
          showError(field, error);
        } else {
          hideError(field);
        }
      });

      requiredFields.forEach((field) => {
        touched[field] = true;
      });

      Object.keys(newErrors).forEach((key) => {
        errors[key] = newErrors[key];
      });

      return Object.keys(newErrors).length === 0;
    };

    const handleSubmit = async (e: Event) => {
      e.preventDefault();

      if (!validateForm()) {
        const firstError = document.querySelector(".border-red-500");
        if (firstError) {
          firstError.scrollIntoView({ behavior: "smooth", block: "center" });
        }
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = "Envoi en cours...";
      submitBtn.classList.add("opacity-50", "cursor-not-allowed");

      try {
        const formData = new FormData(form);
        const data: { [key: string]: string } = {};
        formData.forEach((value, key) => {
          data[key] = value as string;
        });

        // Send to API
        const response = await fetch('/api/send-vps-quote', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (response.ok) {
          successMessage.classList.remove("hidden");
          form.reset();

          // Scroll to success message
          successMessage.scrollIntoView({ behavior: "smooth", block: "center" });

          // Hide success message after 5 seconds
          setTimeout(() => {
            successMessage.classList.add("hidden");
            Object.keys(touched).forEach((key) => delete touched[key]);
            Object.keys(errors).forEach((key) => delete errors[key]);
          }, 5000);
        } else {
          alert(result.error || "Une erreur est survenue lors de l'envoi du formulaire.");
        }
      } catch (error) {
        console.error("Error submitting form:", error);
        alert("Erreur de connexion. Veuillez réessayer.");
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Envoyer";
        submitBtn.classList.remove("opacity-50", "cursor-not-allowed");
      }
    };

    // Attach event listeners
    const inputs = form.querySelectorAll(".vps-form-input");
    inputs.forEach((input) => {
      input.addEventListener("change", handleInputChange);
      input.addEventListener("blur", handleBlur);
    });

    form.addEventListener("submit", handleSubmit);
  });
</script>
