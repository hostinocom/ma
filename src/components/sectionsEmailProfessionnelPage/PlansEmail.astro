---
import AnimatedButton from "../ui/AnimatedButton.astro";

type Plan = {
  id: number;
  name: string;
  subtext?: string;
  gbOptions: {
    gb: string;
    price: string;
  }[];
  defaultGb: string;
  performance_stars: number;
  order: {
    text: string;
    href: string;
  };
  features: (string | { html: string })[];
  most_popular: {
    text: string;
    is_most_popular: boolean;
    mostPopularGb?: string;
  };
  countUser: string;
};

type Props = {
  className?: string;
  title?: string;
  smallTitle?: string;
  plans?: Plan[];
  heroHeading?: boolean;
  bigTitle?: string;
  namePlaneBold?: boolean;
  titleExiste?: boolean;
  id?: string;
};

const hostingPlans: Plan[] = [
  {
    id: 1,
    name: "Maily®",
    gbOptions: [
      { gb: "8GB", price: "25 Dhs/mois" },
      { gb: "25GB", price: "45 Dhs/mois" },
    ],
    defaultGb: "8GB",
    performance_stars: 1,
    order: {
      text: "Commander",
      href: "https://my.hostino.com/order.php?pid=75&language=french&country=MA&currency=1",
    },
    features: [
      "Webmail",
      "POP/IMAP/SMTP",
      "Compatibilité <b>Outlook</b>",
      "Compatibilité <b>iOS / Android</b>",
      "Gestion des contacts",
      "Sécurité DNS <b>SPF, DKIM, DMARC</b>",
      { html: `<span class="opacity-20">Intégration ZOOM</span>` },
      { html: `<span class="opacity-20">Gestion centralisée des signatures</span>` },
      { html: `<span class="opacity-20">Gestion des tâches</span>` },
      { html: `<span class="opacity-20">Logo personnalisé</span>` },
      { html: `<span class="opacity-20">Calendrier</span>` },
      { html: `<span class="opacity-20">Exchange ActiveSync</span>` },
      "<br />",
      "<b>Sécurité</b>",
      "Antispam",
      "Antivirus",
      "Sauvegarde automatique",
      { html: `<span class="opacity-20">Double authentification</span>` },
      { html: `<span class="opacity-20">Restriction d'adresse IP</span>` },
      { html: `<span class="opacity-20">Accès forcé avec OTP</span>` },
      "<br />",
      "<b>30 jours</b> satisfait ou remboursé",
      "Support par <b>téléphone et ticket</b>",
    ],
    most_popular: {
      text: "Le plus vendu",
      is_most_popular: false,
    },
    countUser: "par utilisateur / par mois",
  },
  {
    id: 2,
    name: "Maily® Plus",
    subtext: "Hébergement idéal pour les petits sites à faible consommation de ressources.",
    gbOptions: [
      { gb: "8GB", price: "35 Dhs/mois" },
      { gb: "25GB", price: "50 Dhs/mois" },
      { gb: "50GB", price: "65 Dhs/mois" },
    ],
    defaultGb: "25GB",
    performance_stars: 4,
    order: {
      text: "Commander",
      href: "https://my.hostino.com/order.php?pid=76&language=french&currency=1&country=MA",
    },
    features: [
      "Webmail",
      "POP/IMAP/SMTP",
      "Compatibilité <b>Outlook</b>",
      "Compatibilité <b>iOS / Android</b>",
      "Gestion des contacts",
      "Sécurité DNS <b>SPF, DKIM, DMARC</b>",
      "Intégration ZOOM",
      "Gestion centralisée des signatures",
      "Gestion des tâches",
      "Logo personnalisé",
      "Calendrier",
      { html: `<span class="opacity-20">Exchange ActiveSync</span>` },
      "<br />",
      "<b>Sécurité</b>",
      "Antispam",
      "Antivirus",
      "Sauvegarde automatique",
      "Double authentification",
      "Restriction d'adresse IP",
      "Accès forcé avec OTP",
      "<br />",
      "<b>30 jours</b> satisfait ou remboursé",
      "Support par <b>téléphone et ticket</b>",
    ],
    most_popular: {
      text: "Le plus vendu",
      is_most_popular: true,
      mostPopularGb: "25GB",
    },
    countUser: "par utilisateur / par mois",
  },
  {
    id: 3,
    name: "Maily® Pro",
    gbOptions: [
      { gb: "8GB", price: "45 Dhs/mois" },
      { gb: "50GB", price: "75 Dhs/mois" },
      { gb: "100GB", price: "130 Dhs/mois" },
    ],
    defaultGb: "8GB",
    performance_stars: 5,
    order: {
      text: "Commander",
      href: "https://my.hostino.com/order.php?pid=80&language=french&currency=1&country=MA",
    },
    features: [
      "Webmail",
      "POP/IMAP/SMTP",
      "Compatibilité <b>Outlook</b>",
      "Compatibilité <b>iOS / Android</b>",
      "Gestion des contacts",
      "Sécurité DNS <b>SPF, DKIM, DMARC</b>",
      "Intégration ZOOM",
      "Gestion centralisée des signatures",
      "Gestion des tâches",
      "Logo personnalisé",
      "Calendrier",
      "Exchange ActiveSync",
      "<br />",
      "<b>Sécurité</b>",
      "Antispam",
      "Antivirus",
      "Sauvegarde automatique",
      "Double authentification",
      "Restriction d'adresse IP",
      "Accès forcé avec OTP",
      "<br />",
      "<b>30 jours</b> satisfait ou remboursé",
      "Support par <b>téléphone et ticket</b>",
    ],
    most_popular: {
      text: "Le plus vendu",
      is_most_popular: false,
    },
    countUser: "par utilisateur / par mois",
  },
];

const {
  className = "",
  title,
  heroHeading = false,
  plans = hostingPlans,
  namePlaneBold = false,
  id = "plans",
} = Astro.props;

// Price mapping for each plan
const priceMap: Record<number, Record<string, string>> = {};
plans.forEach((plan) => {
  priceMap[plan.id] = {};
  plan.gbOptions.forEach((option) => {
    priceMap[plan.id][option.gb] = option.price;
  });
});

const getWidthClass = (totalPlans: number) => {
  if (totalPlans === 2) {
    return "w-full md:w-[100%] lg:mx-0 md:mx-[150px] lg:mb-[35px] md:mb-[50px] mb-[35px] lg:w-[38%]";
  }
  return "w-full md:w-[100%] lg:mx-0 md:mx-[150px] lg:mb-[35px] md:mb-[50px] mb-[35px] lg:w-[32%]";
};
---

<section id={id} class={`${className} overflow-hidden relative`}>
  <div class="container">
    {!heroHeading && (
      <div class="text-center">
        <h2 class="title-section text-title">
          Choisissez votre plan email<br class="sm:block hidden" /> professionnel Maroc
        </h2>
      </div>
    )}

    <div
      class={`${
        plans.length > 2
          ? "lg:gap-x-[1.33%] gap-y-[1.33%] lg:justify-self-start justify-center"
          : "gap-x-[5%] justify-center"
      } flex flex-wrap py-[30px] w-full`}
    >
      {plans.map((plan) => {
        const currentOption = plan.gbOptions.find((opt) => opt.gb === plan.defaultGb) || plan.gbOptions[0];
        
        return (
          <div
            class={`${
              plan.most_popular.is_most_popular ? "border-3 border-primary" : ""
            } bg-white relative lg:text-left text-center rounded-[10px] 
            ${getWidthClass(plans.length)}
            md:pt-[55px] md:px-[50px] md:pb-[50px] lg:pt-[50px] lg:pb-[40px] lg:px-[40px] pt-[45px] px-[25px] pb-[35px] border border-gray-300 h-full`}
            data-plan-id={plan.id}
          >
            {plan.most_popular.is_most_popular && (
              <div class="absolute py-[8px] bg-primary px-[20px] text-[16px] sm:left-1/3 left-1/2 top-0 -translate-x-1/2 -translate-y-1/2 text-white text-center font-[500] inline-block">
                {plan.most_popular.text.toUpperCase()}
              </div>
            )}

            <h3
              class={`${namePlaneBold ? "lg:text-[34px]" : "lg:text-[26px]"} md:text-left text-center md:text-[31px] text-[28px] text-title font-[600] md:leading-[33px] leading-[1.3em] mb-4`}
              set:html={plan.name}
            />

            <div class="border-t py-[15px] border-gray-200 my-4"></div>

            <div class="flex rounded-[6px] max-w-max overflow-hidden items-center lg:justify-start justify-center mb-6 flex-wrap" data-gb-selector={plan.id}>
              {plan.gbOptions.map((option) => (
                <button
                  type="button"
                  data-gb={option.gb}
                  data-plan-id={plan.id}
                  class={`gb-selector py-[10px] px-[24px] font-[600] text-[16px] transition ${
                    option.gb === plan.defaultGb
                      ? "bg-primary text-white"
                      : "bg-title text-white hover:bg-primary"
                  }`}
                >
                  {option.gb}
                </button>
              ))}
            </div>

            <!-- Pricing -->
            <div class="mb-6">
              <p class="text-base text-title font-[600] mb-1">À seulement</p>
              <p
                class="text-[40px] font-[600] leading-[54px] text-[#14213D]"
                style="font-family: 'Montserrat', sans-serif;"
                data-price-display={plan.id}
              >
                {currentOption.price}
              </p>
            </div>

            <a
              href={plan.order.href}
              class={`w-full ${
                plan.most_popular.is_most_popular
                  ? "bg-primary"
                  : "bg-title hover:bg-primary transition"
              } text-white flex items-center mt-[18px] gap-3 justify-center font-[600] py-[16px] rounded-[10px] text-center mb-4 transition`}
              target="_blank"
              rel="noopener noreferrer"
            >
              {plan.order.text}
              <svg
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="4"
                stroke="currentColor"
                class="size-3 font-[600]"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="m8.25 4.5 7.5 7.5-7.5 7.5"
                />
              </svg>
            </a>

            <p class="text-[14px] text-title mb-12">{plan.countUser}</p>

            <div class="border-t border-gray-200 my-4"></div>

            <ul class="text-title text-sm space-y-2 flex-grow">
              {plan.features.map((feature) => (
                <li class="flex items-center lg:justify-start justify-center">
                  {typeof feature === "object" && feature !== null && "html" in feature ? (
                    <Fragment set:html={feature.html} />
                  ) : (
                    <span class="text-title" set:html={feature} />
                  )}
                </li>
              ))}
            </ul>
          </div>
        );
      })}
    </div>
  </div>
</section>

<script define:vars={{ priceMap }}>
    document.addEventListener("DOMContentLoaded", () => {
    const gbSelectors = document.querySelectorAll(".gb-selector");

    gbSelectors.forEach((button) => {
      button.addEventListener("click", () => {
        const planId = parseInt(button.getAttribute("data-plan-id") || "0");
        const selectedGb = button.getAttribute("data-gb") || "";
        const card = button.closest(`[data-plan-id="${planId}"]`);
        const priceDisplay = card?.querySelector(`[data-price-display="${planId}"]`);

        // Update active button
        const allButtons = card?.querySelectorAll(`[data-plan-id="${planId}"].gb-selector`);
        allButtons?.forEach((btn) => {
          if (btn === button) {
            btn.classList.remove("bg-title");
            btn.classList.add("bg-primary");
          } else {
            btn.classList.remove("bg-primary");
            btn.classList.add("bg-title");
          }
        });

        // Update price
        if (priceDisplay && priceMap[planId] && priceMap[planId][selectedGb]) {
          priceDisplay.textContent = priceMap[planId][selectedGb];
        }
      });
    });
  });
</script>